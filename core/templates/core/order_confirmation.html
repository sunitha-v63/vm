{% extends 'core/base.html' %} {% load static %} 
{% load humanize %}
{% block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link rel="stylesheet" href="{% static 'css/order_confirmation.css' %}" />

{% endblock %} 
{% block content %}

<div class="container py-5 order-confirmation">

    <div class="text-center mb-4">
        <h2 class="title1 fw-bold">üéâ Order Placed Successfully!</h2>
        <p class="text-muted">Thank you for shopping with VetriMart üõí</p>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="section-card left-card animate-left">

                {% if order.status != "out_for_delivery" and order.status != "delivered" %}
                <div class="action-buttons d-flex gap-2 mb-3">

                    <a href="{% url 'edit_order' order.id %}" class="btn btn-warning flex-grow-1 edit">
                        ‚úèÔ∏è Edit Delivery Details
                    </a>

                    <button class="btn btn-danger flex-grow-1 cancel" data-bs-toggle="modal" data-bs-target="#cancelConfirmModal">
                        ‚ùå Cancel Order
                    </button>

                </div>
                {% endif %}

                {% if user.is_superuser %}
                <div class="d-grid mb-3">
                    <a href="{% url 'start_dispatch' order.id %}" class="btn btn-dark">
                        üöö Start Dispatch
                    </a>
                </div>
                {% endif %}

                <h4 class="section-title mt-3">Order Details</h4>

                <p><strong>Order ID:</strong> #{{ order.id }}</p>
                <p><strong>Placed On:</strong> {{ order.created_at|date:"M d, Y h:i A" }}</p>
                <p>
                 <strong>Status:</strong>
                <span class="badge 
                   {% if order.status == 'confirmed' %} bg-success
                   {% elif order.status == 'processing' %} bg-warning
                   {% elif order.status == 'out_for_delivery' %} bg-info
                   {% elif order.status == 'delivered' %} bg-primary
                   {% else %} bg-secondary {% endif %}">
                   {{ order.status|capfirst }}
                </span>
                </p>

                <h4 class="section-title mt-4">Delivery Information</h4>

                <p><strong>Name:</strong> {{ order.full_name }}</p>
                <p><strong>Address:</strong> {{ order.street_address }}, {{ order.city }}</p>
                <p><strong>Pincode:</strong> {{ order.delivery_zone.pincode }}</p>

               {% if order.expected_delivery_time %}
<p><strong>Expected Delivery:</strong>
    {{ order.expected_delivery_time|date:"M d, Y h:i A" }}
    ({{ order.expected_delivery_time|naturaltime }})
</p>
{% else %}
<p><strong>Expected Delivery:</strong> Calculating ETA...</p>
{% endif %}

                <div id="countdownTimer" 
                     data-eta="{{ order.expected_delivery_time|date:'c' }}"
                     class="fw-bold mt-2 fs-5 text-black">
                </div>

            </div>
        </div>

    <div class="col-lg-6">
      <div class="section-card right-card animate-right">

        <h4 class="section-title">Order Summary</h4>

        <ul class="list-group border-0">
          {% for item in order.items.all %}
          <li class="list-group-item lititle border-0 d-flex justify-content-between">
            {{ item.product.title }} √ó {{ item.quantity }}
            <span>‚Çπ{{ item.price|floatformat:2 }}</span>
          </li>
          {% endfor %}
        </ul>

        <hr />

        <div class="d-flex justify-content-between fw-semibold">
          <span>Subtotal:</span>
          <span>‚Çπ{{ order.subtotal|floatformat:2 }}</span>
        </div>

        <div class="d-flex justify-content-between fw-semibold">
          <span>Tax (5%):</span>
          <span>‚Çπ{{ order.tax|floatformat:2 }}</span>
        </div>

        <div class="d-flex justify-content-between fw-bold fs-5 mt-2">
          <span>Total:</span>
          <span>‚Çπ{{ order.total_amount|floatformat:2 }}</span>
        </div>

        <h4 class="section-title mt-4">Order Tracking</h4>

        <div class="delivery-track mt-3">
          <div id="progressFill" class="progress-fill bg-warning"></div>
          <div id="truckIcon" class="truck-icon">üöö</div>
        </div>

        <div class="text-center mt-4 d-flex flex-wrap justify-content-center gap-2">
          <a href="{% url 'home' %}" class="btn btn-secondary px-4 py-2">
            Continue Shopping
          </a>

          <a href="{% url 'track_order' %}?order_id={{ order.id }}" class="btn btn-warning px-4 py-2">
            Track Order
          </a>
        </div>
      </div>
    </div>

    </div>
</div>
{% endblock %}






{% block extra_js %}
<script src="{% static 'js/order_confirmation.js' %}"></script>

<div class="modal fade" id="cancelConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Cancel Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        Are you sure you want to cancel this order?
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        <form action="{% url 'cancel_order' order.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Confirm Cancel</button>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %} 